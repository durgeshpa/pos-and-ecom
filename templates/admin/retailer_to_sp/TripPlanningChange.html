{% extends 'admin/retailer_to_sp/trip/base.html' %}

{% block title %}Trip Planning | Admin{% endblock %}
{% block breadcrumb1 %}Retailer_To_Sp{% endblock %}
{% block breadcrumb2 %}Trip{% endblock %}
{% block breadcrumb3 %}Trip Planning{% endblock %}

{% block content %}
          <!-- Content -->
         <div id="content" class="colM">
            <h1>{{form.instance}}</h1>
            <div id="content-main">
               <ul class="object-tools">
                  <!--<li>-->
                  <!--<a href="/admin/retailer_to_sp/orderedproduct/119/history/" class="historylink">History</a>-->
                  <!--</li>-->
               </ul>
               <form method="post" enctype="multipart/form-data">
                  <div>
                     <fieldset class="module aligned ">
                        {% csrf_token %}
                        {% if form.errors %}
                        {% for error in form.non_field_errors %}
                        <p class="errornote">
                           {{ error|escape }}
                        </p>
                        {% endfor %}
                        {% endif %}
                        {% for hidden in form.hidden_fields %}
                        {{ hidden.errors }}
                        {{ hidden }}
                        {% endfor %}
                        {% for field in form.visible_fields %}
                        <p><label for="{{ field.auto_id }}">{{field.label}}:    {% if field.field.required %}
                           <span class="required">*</span>
                           {% endif %}
                           </label>{{ field.errors }}{{ field }}
                        </p>
                        {{ field.widget.attrs.id }}
                        {% endfor %}
                     </fieldset>
                     <div class="js-inline-admin-formset inline-group"
                        data-inline-type="tabular"
                        data-inline-formset="{&quot;name&quot;: &quot;#rt_order_product_order_product_mapping&quot;, &quot;options&quot;: {&quot;prefix&quot;: &quot;rt_order_product_order_product_mapping&quot;, &quot;addText&quot;: &quot;Add another Ordered product mapping&quot;, &quot;deleteText&quot;: &quot;Remove&quot;}}">
                        <div class="tabular inline-related last-related">
                           <fieldset id="inline" class="module ">
                           <table id="formset" class="form">
                              <tbody id="data">
                              <thead>
                                 <tr id="heading">
                                    <th>Select</th>
                                    <th>Invoice No.</th>
                                    <th>Invoice Amount</th>
                                    <th>Shipment Status</th>
                                    <th>Invoice City</th>
                                    <th>Invoice Date</th>
                                    <th>Order</th>
                                    <th>Shipment Address</th>
                                 </tr>
                                 <tr id="loading">
                                    <th>Loading...</th>
                                 </tr>
                               </thead>
                              </tbody>
                           </table>
                        </div>
                     </div>
                     <div class="submit-row">
                        <input type="submit" value="Save" class="default" name="_save">
                        <p class="deletelink-box"><a href="/admin/retailer_to_sp/" class="deletelink">Back</a></p>
                     </div>
                  </div>
               </form>
            </div>
            <br class="clear">
         </div>
         <!-- END Content -->
{% endblock %}

{% block javascript %}
<script >
    
  var list = new Array();
  var uncheckedlist = new Array();
  var initialload = true;
  $(document).ready(function() {
    HideField('tr#heading');
    HideField('tr#loading');
    Select2Field('#id_seller_shop');
    Select2Field('#id_delivery_boy');
    SubmitFormConfirmDialog();
    GetResultOnTypingArea();
    AddCheckedIDToList();
    CallAPI();
  });



function Select2Field(id) {
  $(id).select2();
}

function HideField(id){
  $(id).hide();
}

function ShowField(id){
  $(id).show();
}

function SubmitFormConfirmDialog(){
  $('form').bind('submit', function(e) {
      if ($('input[type=checkbox]:checked').length) {
          var c = confirm("Click OK to continue?");
          return c;
      } else {
          e.preventDefault(e);
          alert("Please select at least one shipment");

      }
  }); 
}

function GetURL() {
  var host = location.protocol + '//' + location.hostname + (location.port ? ':' + location.port : '') + '/';
  var url = host + 'admin/retailer_to_sp/cart/load-dispatches/';
  return url;
}

function GetResultOnTypingArea(){
  $('#id_search_by_area').on('input', function() {
      EmptyElement('tbody#data');
      HideField('tr#heading');
      ShowField('tr#loading');
      var area = $(this).val();
      var seller_shop = $('#id_seller_shop').val();
      var trip_id = $('#id_trip_id').val();

      if (seller_shop.length == 0) {
          alert("Please select Seller Shop first!");
      } else {
          $.ajax({
              url: GetURL(),
              data: {
                  'seller_shop_id': seller_shop,
                  'area': area,
                  'trip_id': trip_id

              },
              success: function(data) {
                CheckResponse(data);
              }
          });
      }
  });
}

function GetResultByTripAndSellerShop() {
  var seller_shop_id = $('select#id_seller_shop').val();
  var trip_id = $('#id_trip_id').val();
  EmptyElement('tbody#data');
  HideField('tr#heading');
  ShowField('tr#loading');
  var seller_shop_id = $("option:selected").val();
  $.ajax({
      url: GetURL(),
      data: {
          'seller_shop_id': seller_shop_id,
          'trip_id': trip_id
      },
      success: function(data) {
        CheckResponse(data);
      }
  });
}

function GetResultByTripID() {
  var trip_id = $('#id_trip_id').val();
  EmptyElement('tbody#data');
  HideField('tr#heading');
  ShowField('tr#loading');
  var seller_shop_id = $("option:selected").val();
  $.ajax({
      url: GetURL(),
      data: {
          'trip_id': trip_id
      },
      success: function(data) {
        CheckResponse(data);
      }
  });
}

function CheckResponse(data){
  if (data['is_success']){
    EmptyElement('tbody#data');
    ShowField('tr#heading');
    HideField('tr#loading');
    CreateResponseTable(data);
  } else{
    EmptyElement('tbody#data');
    HideField('tr#heading');
    HideField('tr#loading');
    ShowMessage(data['message']);
  }
}

function ShowMessage(msg){
  $("tbody#data").append("<tr><td>"+msg+"<td></tr>");
}

function CreateResponseTable(data){
  var trip_id = $('#id_trip_id').val();
  for (var i = 0; i < data['response_data'].length; i++) {
      var row = "row1";
      if (i % 2 === 0) {
          var row = "row2";
      }
      var pk = data['response_data'][i]['pk'];
      var trip = data['response_data'][i]['trip'];

      var order = "<td>" + data['response_data'][i]['order'] + "</td>";
      var shipment_status = "<td>" + data['response_data'][i]['shipment_status'] + "</td>";
      if (GetTripStatus() == ('COMPLETED')){
        var invoice_no = "<td><a href='/admin/retailer_to_sp/orderedproduct/"+pk+"/change/' target='_blank'>"+ data['response_data'][i]['invoice_no'] + "</a></td>";
      }else {
        var invoice_no = "<td><a href='/admin/retailer_to_sp/dispatch/"+pk+"/change/' target='_blank'>"+ data['response_data'][i]['invoice_no'] + "</a></td>";
      }
      var invoice_amount = "<td>" + data['response_data'][i]['invoice_amount'] + "</td>";
      var invoice_city = "<td>" + data['response_data'][i]['invoice_city'] + "</td>";
      var shipment_address = "<td>" + data['response_data'][i]['shipment_address'] + "</td>";
      var created_at = "<td>" + data['response_data'][i]['created_at'] + "</td>";

      if(trip==trip_id && (jQuery.inArray(pk.toString(), uncheckedlist)=='-1')){
        if (GetTripStatus() != ('READY')){
            var select = "<td><input type='checkbox' class='shipment_checkbox' value='"+pk+"' checked disabled='disabled'></td>";
        }
        else{
          var select = "<td><input type='checkbox' class='shipment_checkbox' value='"+pk+"' checked></td>";
        }
        if (initialload) {
          list.push(pk.toString());
        }
        $('#id_selected_id').val(list);
        $("tbody#data").prepend("<tr class=" + row + ">" + select + invoice_no + invoice_amount + shipment_status + invoice_city + created_at + order + shipment_address +"</tr>");
      } else{
      if (jQuery.inArray(pk.toString(), list)!='-1') {
        var select = "<td><input type='checkbox' class='shipment_checkbox' value='" + pk + "' checked></td>";
      $("tbody#data").prepend("<tr class=" + row + ">" + select + invoice_no + invoice_amount + shipment_status + invoice_city + created_at + order + shipment_address +"</tr>");
      }else {
        var select = "<td><input type='checkbox' class='shipment_checkbox' value='" + pk + "'></td>";
      $("tbody#data").append("<tr class=" + row + ">" + select + invoice_no + invoice_amount + shipment_status + invoice_city + created_at + order + shipment_address +"</tr>");
      }
      }


  }

  initialload = false;
  GetUncheckedFields();
}

function EmptyElement(id){
  $(id).empty();
}

function AddCheckedIDToList(){
  $(document).on('click', '.shipment_checkbox', function() {
      if ($(this).is(':checked')) {
          GetUncheckedFields();
          list.push($(this).val());
          $('#id_selected_id').val(list);

      } else {
          GetUncheckedFields();
          list.splice($.inArray($(this).val(), list),1);
          $('#id_selected_id').val(list);
      }
  });
}

function GetUncheckedFields() {
  uncheckedlist = [];
  $('#id_unselected_id').val('');
  $('.shipment_checkbox').each(function(){
    if (!$(this).is(':checked')) {
      uncheckedlist.push($(this).val());
      $('#id_unselected_id').val(uncheckedlist);
    }
  });
}

function DisableCheckBox() {
  $('.shipment_checkbox').each(function(){
    $(this).attr('disabled','disabled');
  });
}

function GetTripStatus(){
  return $('select#id_trip_status').val();
}

function CallAPI(){
  if (GetTripStatus() != ('READY')){
    GetResultByTripID();
  }
  else{
    GetResultByTripAndSellerShop();
  }
}
</script>
{% endblock %}
